<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - JNV Quiz Admin</title>
    <%- include('partials/head') %>
</head>
<body>
    <%- include('partials/nav') %>

    <div class="container">
        <h1>App Configuration</h1>

        <% if (message) { %>
            <div class="success"><%= message %></div>
        <% } %>

        <form method="POST" action="/admin/config/update">
            <div class="card">
                <h2>OTP Settings</h2>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="otp_rate_limiting_enabled" <%= appConfig.otp_rate_limiting_enabled ? 'checked' : '' %>>
                        Enable OTP Rate Limiting
                    </label>
                </div>

                <div class="form-group">
                    <label for="otp_max_requests_per_hour">Max OTP Requests Per Hour</label>
                    <input type="number" id="otp_max_requests_per_hour" name="otp_max_requests_per_hour" value="<%= appConfig.otp_max_requests_per_hour %>" min="1" max="100" required>
                </div>

                <div class="form-group">
                    <label for="otp_max_verification_attempts">Max Verification Attempts Per OTP</label>
                    <input type="number" id="otp_max_verification_attempts" name="otp_max_verification_attempts" value="<%= appConfig.otp_max_verification_attempts %>" min="1" max="10" required>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="test_mode_enabled" <%= appConfig.test_mode_enabled ? 'checked' : '' %>>
                        Enable Test Mode (OTP returned in API response)
                    </label>
                </div>
            </div>

            <div class="card">
                <h2>WhatsApp OTP Providers</h2>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    Enable or disable WhatsApp OTP providers. API keys and URLs must be configured in <code>.env</code> file.
                </p>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="whatsapp_interakt_enabled" <%= appConfig.whatsapp_interakt_enabled ? 'checked' : '' %>>
                        <strong>Enable Interakt API</strong>
                    </label>
                    <div style="margin-left: 24px; margin-top: 8px;">
                        <% if (whatsappStatus && whatsappStatus.interakt && whatsappStatus.interakt.api_key_configured) { %>
                            <span style="display: inline-block; padding: 4px 12px; background: #d4edda; color: #155724; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                ✓ API Key Configured
                            </span>
                            <% if (whatsappStatus.interakt.template) { %>
                                <span style="color: #666; font-size: 12px; margin-left: 8px;">
                                    Template: <code><%= whatsappStatus.interakt.template %></code>
                                </span>
                            <% } %>
                        <% } else { %>
                            <span style="display: inline-block; padding: 4px 12px; background: #fff3cd; color: #856404; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                ⚠ API Key Not Configured
                            </span>
                        <% } %>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="whatsapp_n8n_enabled" <%= appConfig.whatsapp_n8n_enabled ? 'checked' : '' %>>
                        <strong>Enable n8n Webhook</strong>
                    </label>
                    <div style="margin-left: 24px; margin-top: 8px;">
                        <% if (whatsappStatus && whatsappStatus.n8n && whatsappStatus.n8n.webhook_configured) { %>
                            <span style="display: inline-block; padding: 4px 12px; background: #d4edda; color: #155724; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                ✓ Webhook URL Configured
                            </span>
                        <% } else { %>
                            <span style="display: inline-block; padding: 4px 12px; background: #fff3cd; color: #856404; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                ⚠ Webhook URL Not Configured
                            </span>
                        <% } %>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-left: 4px solid #2196f3; border-radius: 4px;">
                    <strong style="color: #1976d2;">ℹ️ Configuration Guide</strong>
                    <p style="margin: 8px 0; font-size: 13px; color: #555;">
                        These toggles enable/disable providers. To configure API keys and URLs, add these variables to your <code>.env</code> file:
                    </p>
                    <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px; color: #555;">
                        <li><code>WHATSAPP_OTP_ENABLED=true</code> - Master switch for WhatsApp OTP</li>
                        <li><code>INTERAKT_SECRET_KEY=your_key_here</code> - Interakt API secret</li>
                        <li><code>INTERAKT_TEMPLATE_NAME=template_name</code> - Interakt template</li>
                        <li><code>N8N_WEBHOOK_URL=https://your-n8n.com/webhook/otp</code> - n8n webhook URL</li>
                    </ul>
                </div>

                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <strong style="font-size: 13px;">Current Status:</strong>
                    <% if (whatsappStatus && whatsappStatus.enabled) { %>
                        <% if (whatsappStatus.available_methods && whatsappStatus.available_methods.length > 0) { %>
                            <span style="color: #27ae60; font-weight: 600; margin-left: 8px;">
                                ✅ Active (<%= whatsappStatus.available_methods.join(', ') %>)
                            </span>
                        <% } else { %>
                            <span style="color: #e67e22; font-weight: 600; margin-left: 8px;">
                                ⚠ Enabled but no providers configured
                            </span>
                        <% } %>
                    <% } else { %>
                        <span style="color: #e74c3c; font-weight: 600; margin-left: 8px;">
                            ❌ WhatsApp OTP Disabled (Set WHATSAPP_OTP_ENABLED=true in .env)
                        </span>
                    <% } %>
                </div>
            </div>

            <div class="card">
                <h2>Online Users Settings</h2>

                <div class="form-group">
                    <label for="online_count_min">Minimum Online Count</label>
                    <input type="number" id="online_count_min" name="online_count_min" value="<%= onlineConfig.online_count_min %>" min="0" required>
                </div>

                <div class="form-group">
                    <label for="online_count_max">Maximum Online Count</label>
                    <input type="number" id="online_count_max" name="online_count_max" value="<%= onlineConfig.online_count_max %>" min="0" required>
                </div>

                <div class="form-group">
                    <label for="update_interval_minutes">Update Interval (minutes)</label>
                    <input type="number" id="update_interval_minutes" name="update_interval_minutes" value="<%= onlineConfig.update_interval_minutes %>" min="1" max="60" required>
                </div>

                <p style="color: #666; font-size: 14px; margin-top: 10px;">
                    Current online count: <strong><%= onlineConfig.current_online_count %></strong>
                    (updates every <%= onlineConfig.update_interval_minutes %> minutes between <%= onlineConfig.online_count_min %>-<%= onlineConfig.online_count_max %>)
                </p>
            </div>

            <button type="submit">Save Configuration</button>
        </form>
    </div>
</body>
</html>
